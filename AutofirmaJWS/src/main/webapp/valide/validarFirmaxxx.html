<!DOCTYPE html>
<html><head>
	<title>Pagina de Pruebas</title>
	

<link rel="stylesheet" type="text/css" href="css/valide.css">
<link rel="stylesheet" type="text/css" href="css/estilos.css" media="screen">

<meta http-equiv="Expires" content="0">
<meta http-equiv="Last-Modified" content="0">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="content-script-type" content="text/javascript"> 
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta http-equiv="Cache-Control" content="no-cache,no-store">
<meta name="lang" content="es">
<script type="text/javascript" src="js/miniapplet.js"></script>
<script type="text/javascript" src="js/protocolcheck.js"></script>
<script type="text/javascript" src="js/funcionesExtras.js"></script>
<script type="text/javascript" src="js/constantes-server.js"></script>
<script type="text/javascript" src="js/intercomunicacionBrowser-App.js"></script>
	
</head>
<body>
	
	<!-- CONTENEDOR ** -->
	<div id="contenedor" >
		<div id="cabecera" >
			

<div class="cabecera">
	<a href="http://argentina.gob.ar/" title="Administracion" class="floatLeft" target="_blank">
		<img style="padding-top: 15pt"src="../img/logo_admon_a_corto.png" alt="administracion" title="PAGAdmonGobAr" class="logo060x">
	</a>
	<!-- <a href="https://valide.redsara.es/valide/inicio.html" title="VALIDe" class="floatLeft">
		<img src="../img/logoValideHome.PNG" alt="valide.redsara.es" title="VALIDe">
	</a> -->
	<a href="http://www.argentina.gob.ar/home.htm" title="Gobierno de Argentina">
		<img height="100pt" width="200pt" src="../img/logoGobEsp.PNG" alt="www.gob.ar" title="Gobierno de Argentina" class="logoGobEsp">
	</a>
	<!-- MENÚ CABECERA ** -->
	<div class="menuSuperior">
		<div id="menu_cabecera">
			<ul>
				<!-- <li><a href="#" title="Mapa Web">Mapa Web</a> | </li> -->
				<li>
					<a href="https://contactar.html" title="Contactar">
						Contactar
					</a>
			</li></ul>		
		</div>
		
		<!-- IDIOMA ** -->
		<div id="idiomas">
		  <ul>
			<li><a href="https://valide/valide/firmar/ejecutar.html?lang=es" title="Selecciona idioma">Bienvenido</a> | </li>
			<li><a href="https://valide/valide/firmar/ejecutar.html?lang=en" title="Selecciona idioma">Welcome</a>  </li>
		  </ul>		
		</div>
	</div>
</div>
<div class="clear" ></div>
		</div>
		<div id="contenidoTop" ></div>
		<div id="contenido" >
			<div id="cuerpo">
				<div class="bloqueIzquierdoInterior" >
					


                         
	<div class="menuVertical">
		<ul>
			<li>
			    <script type="text/javascript" >
			       document.write('<a href="'+Constants.URL_BASE_APP+'/valide/validarCertificado.html" title="Validar Certificado">Validar Certificado</a>');
			    </script>
				<span class="separadorMenu"></span>
			</li>
			<li>
			    <script type="text/javascript" >
			       document.write('<a href="'+Constants.URL_BASE_APP+'/valide/firmar.html" title="Realizar firma">Realizar firma</a>');
			    </script>			
				<span class="separadorMenu"></span>	
			</li>
			<li>
			    <script type="text/javascript" >
			       document.write('<a href="'+Constants.URL_BASE_APP+'/valide/validarFirma.html" title="Validar Firma">Validar Firma</a>');
			    </script>
				<span class="separadorMenu"></span>	
			</li>
			<li>
			    <script type="text/javascript" >
			       document.write('<a href="'+Constants.URL_BASE_APP+'/valide/validarSede.html" title="Validar Sede Electrónica">Validar Sede Electrónica</a>');
			    </script>
				<span class="separadorMenu"></span>	
			</li>
			<li>
			    <script type="text/javascript" >
			       document.write('<a href="'+Constants.URL_BASE_APP+'/valide/visor.html" title="Visualizar Firma">Visualizar Firma</a>');
			    </script>
				<span class="separadorMenu"></span>	
			</li>
			<li>
			    <script type="text/javascript" >
			       document.write('<a href="'+Constants.URL_BASE_APP+'/valide/faqs.html" title="Faqs">Faqs</a>');
			    </script>
				<span class="separadorMenu"></span>	
			</li>
		
		</ul>                                
	</div>   
				</div>
				<div class="bloqueDerechoInterior">

		<img src="imgfake/valida-firma0.PNG" alt="validar certificado" class="">
        <img src="imgfake/valida-firma1.PNG" alt="validar certificado" class="">
        <img src="imgfake/valida-firma2.PNG" alt="validar certificado" class="">
				</div>
				 <div class="clear"></div>
			</div><!-- FIN DE CUERPO -->
		</div><!-- FIN DE CONTENIDO -->
		<div id="contenidoBottom"></div>
		<div id="pie">
			
<!-- LOGOS PIE ** -->
<span style="float:left; margin:13px 0 0 33px">
    <img src="../img/logo_eu.jpg" alt="FEDER" width="30">
</span>	
<div id="logos" style="width:280px; margin-top:15px">
	<img src="../img/btn_w3c_aa.gif" class="logo_w3c" alt="W3C AA">
	<img src="../img/btn_w3c_css.gif" class="logo_w3c" alt="W3C CSS">
	<img src="../img/btn_w3c_xhtml.gif" class="logo_w3c" alt="W3C HTML">
</div>
<!-- FIN DE LOGOS PIE ** -->
<!-- MENÚ PIE ** -->
<div id="menu_pie" style="margin-top:30px">
	<ul>
		<li><a href="accesibilidad.html" title="Accesibilidad">Accesibilidad</a> | </li>
		<li><a href="guiaNavegacion.html" title="Mapa Web">Mapa Web</a> | </li>
		<li><a href="requisitos.html" title="Requisitos">Requisitos</a> | </li>
		<li><a href="condiciones.html" title="Condiciones de Uso">Condiciones de Uso</a> </li>
	</ul>		
</div><!-- FIN DE MENÚ PIE ** -->

		</div>
	</div> <!-- FIN DE CONTENEDOR -->
	
<script type="text/javascript" defer="defer">

	var signature; //variable que almacenara la firma resultante
	var mobile = false;
	var filename;
	var divMensaje = document.getElementById('divmensaje');
	var btn_firmar = document.getElementById('botonFirmar');
	var btn_save = document.getElementById('saveFile');
	//var saveExtension = "*.csig";
	//var saveDescription = "Firma avanzada CAdES (*.csig)";
	
	var autofirma = true; //para saber si se ejecuta por la aplicacion instalada
	
	//pregunto si es un entorno mobil para poder mostrar los enlaces para descarga del
	//aplicativo para el mobil
	if ((MiniApplet.isAndroid()==true) || (MiniApplet.isIOS()==true)) {
		mobile = true;
	}

	//para saber si se descargo o no la aplicacion inicialmente, osea precarga app jnlp inicial
	function isLoad() {
        //MODIFICAR para que sepa a traves de una variable si realmente se descargo 
        //la aplicacion jnlp, por ejemplo con la llamada a un servicio inicial de echo
		/*var tempCliente2 = document.getElementById("hiddenIframe");
		var appLoaded;
		try {
			appLoaded = tempCliente2 != null ;//&& MiniApplet.echo() != "Cliente JavaScript"; 
		}
		catch (e) {
			appLoaded = false;
		}
		if (appLoaded) {
			return true;
		}
		else {
			return false;
		}*/return true;
		
	}
	
	function firmar() {

		if (isLoad()== false) {
			autofirma = false;
		}
		else {
			autofirma = true;// se ejecuta directamente por protocolo
		}
		//btn_firmar.disabled = true; comento estas lineas porque en caso que no 
		//descargue y ejecute la app 
		//nunca se ejecutaran las funciones de success y error		
		//btn_firmar.classList.remove('botonP');
		//btn_firmar.classList.add('botonGrisadoP');
		
		btn_save.disabled = true;
		divMensaje.innerHTML='&nbsp;';

		var dataB64 = null;
		var format = "AUTO";
		var algorithm = "SHA1withRSA";
		var params="";
		try {
		
			if (mobile==false) {
			
				/*params = "mode=implicit";
				
				if (autofirma==true) {
					dataB64 = null;
				}
				else {
					var fichero = MiniApplet.getFileNameContentBase64("Selecciona un archivo ", "", "");
					
					var separatorIdx = fichero.indexOf("|");
					if ((separatorIdx + 1) < fichero.length) {
						filename = fichero.substring(0, separatorIdx);
						dataB64 = fichero.substring(separatorIdx + 1);
						
						var extension = getExtension(filename) + "";
						extension = extension.toUpperCase();
						
						if (extension == "PDF") {
							saveExtension = "*.pdf";
							saveDescription = "Adobe PDF (*.pdf)";
						}
						else if (extension == "XML" || extension == "XSIG") {
							saveExtension = "*.xsig";
							saveDescription = "Firma XML (*.xsig, *.xml)";
						}
					}
				}				
				MiniApplet.sign(dataB64, "SHA256withRSA", format, params, successCallback, errorCallback);*/
				
				//doSign();
				MiniApplet.sign(
						dataB64,
						algorithm,
						format,
						params,
						successCallback,
						errorCallback);
			}
			
		}
		catch (e) {
			//Se muestra el mensaje de error si NO es de cancelación de la operación
			//por ejemplo mal tipo de algoritmo enviado,etc
			//el canceled no es por parte del usuario sino por ejemplo por no hallarse
			//por lo menos un certificado en el almacen seleccionado, igualmente modifique 
			//este error para que por lo menos me permita seleccionar otro certificado sin
			//emitir esta excepcion
			if ((e.message.indexOf("PrivilegedActionException")==-1) && 
			    (e.message.indexOf("AOCancelledOperationException")==-1) && 
			    (e.message.indexOf("Error calling method on NPObject")==-1) && 
				(e.message.indexOf("Operacion cancelada por el usuario")==-1)) {
				divMensaje.innerHTML='<div class="iconErrorFirma">Error al firmar</div><br><div style="width:300pt">&nbsp;' + e.message + '</div>';
			}
			btn_firmar.disabled = false;
			btn_firmar.classList.remove('botonGrisadoP');
			btn_firmar.classList.add('botonP');
			
		}
		
	}
	
	function guardarFirma(){		
	
		btn_save.classList.remove('botonM');
		btn_save.classList.add('botonGrisadoM');
		
		if (mobile==false) {
			if (autofirma==true) {
				MiniApplet.saveDataToFile(signature, "Guardar firma", null, null, null, successSaveCallback, errorSaveCallback);
			}
			else {//se ejecuta por applet
				/*var saveFile = MiniApplet.saveDataToFile(signature, "Guardar firma", null, null, saveDescription);
				if (saveFile==true) {
					divMensaje.innerHTML='<div class="iconOKFirma">Fichero firmado y almacenado correctamente</div><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;' + filename;
				}*/
			}
		}
	}
	
	/*function getExtension(filename){
		return (/[.]/.exec(filename)) ? /[^.]+$/.exec(filename) : undefined;
	}*/

	function mostrarPantalla()	{
	
		if (isLoad()== false) {
			autofirma = false;
		}
		
		document.getElementById("cargandoApplet").style.display = "none";
		document.getElementById("pantalla").style.display = "block";
		if (mobile==true) {
			document.getElementById("firmaProceso1").style.display = "none";
			document.getElementById("botones").style.display = "none";
			document.getElementById("divmensaje").style.display = "none";
			
			if (MiniApplet.isAndroid()) {
				document.getElementById("firmaProcesoAND").style.display = "inline";
			}
			else if (MiniApplet.isIOS()) {
				document.getElementById("firmaProcesoIOS").style.display = "inline";
			}
			document.getElementById("firmaMovil").style.display = "inline";
			document.getElementById("saveFile").style.display = "none";
			document.getElementById("clienteEscritorio").style.display = "none";
			document.getElementById("nota").style.display = "none";
			document.getElementById("nota2").style.display = "inline";
		}
	}

	function successCallback(signatureB64, certificateB64) {
	
		//en realidad el algoritmo por default es utf-8 pero igualmente no se 
		//toma en cuenta el segundo parametro, abria que eliminarlo si el algoritmo
		//es por default utf-8
		var fichero = signatureB64;//MiniApplet.getTextFromBase64 (signatureB64, "utf-8");
		//MODIF: hacer que la aplicacion envie el (nombre del archivo firmadob64 | datos64)
		var filename = "";
		/*var separatorIdx = fichero.indexOf("|");
		if ((separatorIdx + 1) < fichero.length) {
			filename = fichero.substring(0, separatorIdx);
			dataB64 = fichero.substring(separatorIdx + 1);
			
			var extension = getExtension(filename) + "";
			extension = extension.toUpperCase();
			
			if (extension == "PDF") {
				saveExtension = "*.pdf";
				saveDescription = "Adobe PDF (*.pdf)";
			}
			else if (extension == "XML" || extension == "XSIG") {
				saveExtension = "*.xsig";
				saveDescription = "Firma XML (*.xsig, *.xml)";
			}
		}*/
		
		signature = signatureB64;
		
		if (autofirma == false) {
			divMensaje.innerHTML='<div class="iconOKFirma">Fichero firmado correctamente</div><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'+ filename;
		}
		else {
			divMensaje.innerHTML='<br><div class="iconOKFirma">Fichero firmado correctamente</div><br>&nbsp;';
		}
		btn_firmar.disabled = false;
		btn_firmar.classList.remove('botonGrisadoP');
		btn_firmar.classList.add('botonP');
		btn_save.disabled = false;
		btn_save.classList.remove('botonGrisadoM');
		btn_save.classList.add('botonM');
		
	}
	
	function errorCallback(errorType, errorMessage) {
		if ((errorMessage) && 
(errorMessage.indexOf("AOCancelledOperationException")==-1) && 
(errorMessage.indexOf("Operacion cancelada por el usuario")==-1)) {
			if (errorMessage.indexOf("El almacen no contenia entradas")!=-1) {
				divMensaje.innerHTML='<img class="iconStatus" src="../img/iconFALLO.png">No existen certificados en el almacén de su navegador<br><br>';
			}
			else {
				divMensaje.innerHTML='<div class="iconErrorFirma">Error al firmar</div><br><div style="width:300pt">' + errorMessage + '</div>';
			}
		}
		btn_firmar.disabled = false;
		btn_firmar.classList.remove('botonGrisadoP');
		btn_firmar.classList.add('botonP');
		btn_save.classList.remove('botonM');
		btn_save.classList.add('botonGrisadoM');
	}

	function successSaveCallback() {
		btn_save.classList.remove('botonGrisadoM');
		btn_save.classList.add('botonM');
		divMensaje.innerHTML='<div class="iconOKFirma">Fichero anteriormente firmado y almacenado correctamente</div><br>&nbsp;';
	}

	function errorSaveCallback(errorType, errorMessage) {
		if ((errorMessage) && (errorMessage.indexOf("Operacion cancelada por el usuario")!=-1)) {
			divMensaje.innerHTML='<div class="iconErrorFirma">Operacion de guardado cancelada</div><br><div style="width:300pt">' + '</div>';	}
		    
		else {
				divMensaje.innerHTML='<div class="iconErrorFirma">Error al guardar</div><br><div style="width:300pt">' + errorMessage + '</div>';
				
		}
		//btn_firmar.disabled = false;
		btn_save.classList.remove('botonGrisadoM');
	    btn_save.classList.add('botonM');
	}
	
	function waiting(comando, segundos) {
			var waiting;
			var intento;

			if (waiting) {
					return true;
			}
			else {
					if (segundos==0) {
						eval(comando);
					}
					else {
						segundos = segundos - 1;
					}

					var func = function() 
					{ 
						this.waiting(comando, segundos);
					}
					setTimeout(func, 1000);
			}
	}	

 
</script>
<script type="text/javascript" async>
//descargo la aplicacion asincronicamente pero no hace nada, es solo para tenerla en cache
//ver que al ser asincrona no puedo usar la variable HOST

//NOTA: las lineas de abajo la comente hasta que sepa como predescargar jnlp por unica vez si no esta ya en cache java
//AppJNLP.downloadAppJnlp('jnlp://www.milocal.com:8443/autofirma.jsp');
mostrarPantalla();

//NOTA: modificar la funcion de arriba para poder enviar la funcion a ser llamada cuando
//finaliza la descarga de la aplicacion, por default se ejecuta la funcion
//mostrarPantalla(), y el iframe se llama hiddenIframe
//seteo que se hara cuando termine de cargar el jnlp
//var iframe = document.getElementById("hiddenIframe"); //document.querySelector("#hiddenIframe");
//if (!iframe) {
    //el iframe aun no se creo. pero deberia haberse creado en la llamada de arriba
//}else{
	//iframe.onload= mostrarPantalla();
//}

</script>
<script type="text/javascript" >
var HOST = Constants.URL_BASE_APP;
var storage = "http://www.milocal.com:8080" + "/AlmacenarFirma"; //document.getElementById('storageService').value;
var retrieve = HOST + "/RecuperarFirma";//document.getElementById('retrieveService').value;
var jnlp = Constants.URL_BASE_JNLP;//document.getElementById('jnlpService').value;
MiniApplet.setServlets(storage, retrieve);
MiniApplet.setJnlpService (jnlp); // URL donde esta el generador de JNLP
if (navigator.platform.indexOf("Linux")!=-1 || navigator.platform.indexOf("Mac")!=-1){
//En Mac y Linux se fuerza la utilización de servidores intermedios
MiniApplet.setForceWSMode(true);
}
//dominio desde el que se realiza la llamada al servicio
//MiniApplet.cargarAppAfirma('miniapplet.js');
//MiniApplet.setForceWSMode(true);
MiniApplet.cargarAppAfirma(HOST+'valide/js/miniapplet.js',MiniApplet.KEYSTORE_WINDOWS);

//////////////////////////////////////////////////////
	//MiniApplet.cargarMiniApplet("https://valide.redsara.es/valide/applet");
	
//MiniApplet.setServlets("https://valide.redsara.es/firmaMovil/afirma-signature-storage/StorageService","https://valide.redsara.es/firmaMovil/afirma-signature-retriever/RetrieveService");
    
/*	if (navigator.userAgent.toUpperCase().indexOf("FIREFOX") != -1) {
		if (navigator.javaEnabled() == false) {
			autofirma = true;
			mostrarPantalla();// mostrar despues de la carga
		} else {
			waiting("mostrarPantalla()", 10);
		}
	} 
		if ((navigator.javaEnabled() == false) || (isLoad() == false)) {
			autofirma = true;
		}		
		mostrarPantalla();*/
	
</script>
<!-- <script type="text/javascript" async src="VALIDe_files/funcionesAsincronas.js"></script> -->
<!--<embed id="miniApplet" name="MiniApplet @firma (Gobierno de España)" type="application/x-java-applet" keystore="null" useragent="Mozilla/5.0 (Windows NT 5.1; rv:52.0) Gecko/20100101 Firefox/52.0" archive="https://valide.redsara.es/valide/applet/miniapplet-full_1_4.jar" code="es.gob.afirma.miniapplet.MiniAfirmaApplet" java-vm-args="-Xms512M -Xmx512M " java_arguments="-Xms512M -Xmx512M " system_properties="null" codebase_lookup="false" separate_jvm="true" locale="null" height="1" width="1">
-->

</body></html>